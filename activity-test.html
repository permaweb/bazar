<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Bazar Activity Test</title>
		<style>
			body {
				font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
				max-width: 800px;
				margin: 0 auto;
				padding: 20px;
				line-height: 1.5;
				color: #333;
			}
			h1,
			h2,
			h3 {
				margin-top: 30px;
			}
			pre {
				background-color: #f5f5f5;
				padding: 15px;
				border-radius: 5px;
				overflow: auto;
				font-size: 14px;
			}
			.section {
				margin-bottom: 30px;
				padding: 20px;
				border-radius: 5px;
				border: 1px solid #ddd;
			}
			.result {
				margin-top: 20px;
				padding: 15px;
				background-color: #f0f8ff;
				border-radius: 5px;
			}
			button {
				background-color: #4caf50;
				border: none;
				color: white;
				padding: 10px 20px;
				text-align: center;
				text-decoration: none;
				display: inline-block;
				font-size: 16px;
				margin: 10px 2px;
				cursor: pointer;
				border-radius: 5px;
			}
			input {
				padding: 10px;
				margin: 10px 0;
				width: 300px;
				font-size: 16px;
			}
			.loading {
				display: inline-block;
				width: 20px;
				height: 20px;
				border: 3px solid rgba(255, 255, 255, 0.3);
				border-radius: 50%;
				border-top-color: #4caf50;
				animation: spin 1s ease-in-out infinite;
			}
			@keyframes spin {
				to {
					transform: rotate(360deg);
				}
			}
		</style>
	</head>
	<body>
		<h1>Bazar Activity Test Page</h1>
		<p>This page tests the Arweave GraphQL activity data fetching for user profiles.</p>

		<div class="section">
			<h2>Test Configuration</h2>
			<label for="address">Wallet Address to Test:</label>
			<input type="text" id="address" value="D5f-YauICIy3tVyGZKXiKxErKTZT7L7z941d1VlsIao" />
			<button id="runTest">Run Test</button>
		</div>

		<div class="section">
			<h2>GraphQL Query Test</h2>
			<div id="queryResult" class="result">
				<p>Click "Run Test" to fetch activity data...</p>
			</div>
		</div>

		<div class="section">
			<h2>Manual GraphQL Test</h2>
			<p>You can also execute a direct GraphQL query to arweave.net:</p>
			<button id="runDirect">Run Direct Query</button>
			<div id="directResult" class="result">
				<p>Click "Run Direct Query" to test...</p>
			</div>
		</div>

		<script>
			// Constants
			const ARWEAVE_GATEWAY_URL = 'https://arweave.net/graphql';

			// Helper function to execute GraphQL queries
			async function executeQuery(query, variables) {
				try {
					console.log('Executing GraphQL query:', { query, variables });

					const response = await fetch(ARWEAVE_GATEWAY_URL, {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({
							query: query,
							variables: variables,
						}),
					});

					if (!response.ok) {
						throw new Error(`GraphQL request failed with status ${response.status}`);
					}

					const data = await response.json();

					if (data.errors) {
						console.error('GraphQL errors:', data.errors);
						return { data: { transactions: { edges: [] } } };
					}

					return data;
				} catch (error) {
					console.error('Error executing GraphQL query:', error);
					return { data: { transactions: { edges: [] } } };
				}
			}

			// Direct test query
			const TEST_QUERY = `
            query GetUserActivity($address: String!, $first: Int!) {
                transactions(
                    first: $first,
                    tags: [
                        { name: "Data-Protocol", values: ["ao"] }
                        { name: "Type", values: ["Message"] }
                        { name: "Owner", values: [$address] }
                    ]
                ) {
                    edges {
                        node {
                            id
                            owner {
                                address
                            }
                            tags {
                                name
                                value
                            }
                            block {
                                timestamp
                            }
                        }
                    }
                }
            }
        `;

			// Event Handlers
			document.getElementById('runTest').addEventListener('click', async () => {
				const resultDiv = document.getElementById('queryResult');
				const address = document.getElementById('address').value.trim();

				if (!address) {
					resultDiv.innerHTML = '<p style="color: red;">Please enter a wallet address</p>';
					return;
				}

				resultDiv.innerHTML = '<div class="loading"></div> Fetching activity data...';

				try {
					// Test a simple query first
					const userActivityQuery = TEST_QUERY.replace(/\$address/g, `"${address}"`);
					const result = await executeQuery(userActivityQuery, { first: 20 });

					if (result && result.data && result.data.transactions) {
						const edges = result.data.transactions.edges || [];

						resultDiv.innerHTML = `
                        <h3>Results:</h3>
                        <p>Found ${edges.length} transactions for address ${address}</p>
                        ${edges.length > 0 ? '<h4>Sample Transaction:</h4>' : ''}
                        ${edges.length > 0 ? `<pre>${JSON.stringify(edges[0], null, 2)}</pre>` : ''}
                    `;
					} else {
						resultDiv.innerHTML = '<p>No activity data found or error in response.</p>';
					}
				} catch (error) {
					resultDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
					console.error('Test error:', error);
				}
			});

			document.getElementById('runDirect').addEventListener('click', async () => {
				const resultDiv = document.getElementById('directResult');
				const address = document.getElementById('address').value.trim();

				if (!address) {
					resultDiv.innerHTML = '<p style="color: red;">Please enter a wallet address</p>';
					return;
				}

				resultDiv.innerHTML = '<div class="loading"></div> Running direct query...';

				try {
					// Alternative query for direct transfers
					const directQuery = `
                    query {
                        transactions(
                            first: 10,
                            recipients: ["${address}"]
                        ) {
                            edges {
                                node {
                                    id
                                    owner {
                                        address
                                    }
                                    recipient
                                    tags {
                                        name
                                        value
                                    }
                                }
                            }
                        }
                    }
                `;

					const response = await fetch(ARWEAVE_GATEWAY_URL, {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ query: directQuery }),
					});

					const data = await response.json();

					resultDiv.innerHTML = `
                    <h3>Direct Query Results:</h3>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
				} catch (error) {
					resultDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
					console.error('Direct query error:', error);
				}
			});
		</script>
	</body>
</html>
